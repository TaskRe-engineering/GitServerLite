#!/bin/bash

#for debugging
#set -ex

#
# Copyright Â© 2023 Task Re-engineering Inc.
# All rights reserved.
# 
# This source code is licensed under the [] license found in the
# LICENSE file in the root directory of this source tree. 
#

shopt -s nullglob

ref=$1
GIT_DIR=$2

SOURCE_DIR=".gitserverlite"
source "$SOURCE_DIR/env"
source "$SOURCE_DIR/gsl-deployment-import"

DEPLOY_BRANCHES_DIR="$GIT_DIR/$SOURCE_DIR/deploy_branches"
BRANCHES=("$DEPLOY_BRANCHES_DIR"/*)

PARAMS="--build --detach"

MATCH="$(match $ref $BRANCHES)"
if [[ ! -z "$MATCH" ]];
then
        echo "Ref $ref received. Matches branch configured to automatically deploy."

        load $MATCH
        BRANCH="$(branch $MATCH $DEPLOY_BRANCHES_DIR)"
        
        process $GIT_DIR $DEPLOY_DIR $PARAMS $BRANCH $ENV_FILE
else
        echo "Ref $ref received. Doing nothing: does not match branches configured to automatically deploy."
fi
