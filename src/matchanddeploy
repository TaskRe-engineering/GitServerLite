#!/bin/bash

#for debugging
#set -ex

#
# Copyright Â© 2023 Task Re-engineering Inc.
# All rights reserved.
# 
# This source code is licensed under the [] license found in the
# LICENSE file in the root directory of this source tree. 
#

shopt -s nullglob

ref="$1"
GIT_DIR="$2"

GSL_DIR=".gitserverlite"

source "$GSL_DIR/env"
source "$GSL_DIR/gsl-branch"
source "$GSL_DIR/gsl-file"
source "$GSL_DIR/gsl-deploy"

GSL_DEPLOY_BRANCHES_DIR="$GIT_DIR/$GSL_DIR/deploy_branches"
get_branches

GSL_PARAMS="--build --detach"

match="$(match "$ref")"
if [[ ! -z "$match" ]];
then
    echo "Ref $ref received. Matches branch configured to automatically deploy."

    load_branch_file "$match"
    branch="$(branch "$match" "$GSL_DEPLOY_BRANCHES_DIR")"
    
    process "$GIT_DIR" "$GSL_DEPLOY_DIR" "$GSL_PARAMS" "$branch" "$ENV_FILE"
else
    echo "Ref $ref received. Doing nothing: does not match branches configured to automatically deploy."
fi
